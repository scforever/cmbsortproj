<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸运一滴 - Lucky Drop Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(200px) rotate(360deg) scale(0.5);
            }
        }

        @keyframes confettiBurst {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            20% {
                opacity: 1;
                transform: translate(calc(var(--end-x) - 50%), calc(var(--end-y) - 50%)) rotate(calc(var(--rotation) * 0.3)) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(calc(var(--end-x) - 50%), calc(var(--end-y) - 50% + 100px)) rotate(var(--rotation)) scale(0.3);
            }
        }

        @keyframes bounce-scale {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }

            50% {
                opacity: 1;
                transform: scale(1.1) translateY(0);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes gift-open {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fly-up {
            0% {
                opacity: 0;
                transform: translateY(0px) scale(0.3);
            }

            50% {
                opacity: 1;
                transform: translateY(-10px) scale(1.1);
            }

            100% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
        }

        /* 层级脉冲动画 */
        @keyframes layer-pulse {
            0% { 
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
            }
            100% { 
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.8);
            }
        }

        /* 水波纹效果 */
        @keyframes water-flow {
            0% { left: -100%; opacity: 0.8; }
            50% { opacity: 1; }
            100% { left: 100%; opacity: 0.8; }
        }

        /* 冒泡动画 */
        @keyframes bubble-up {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(10px) scale(0.8); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(-5px) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0px) scale(1); 
            }
        }

        /* 玩家瓶移动到目标位置动画 */
        @keyframes bottle-move-to-target {
            0% { 
                transform: rotate(12deg) translateX(0) translateY(0); 
            }
            100% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
        }

        /* 玩家瓶倒水动画（倾斜更多） */
        @keyframes bottle-pour {
            0% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            100% { 
                transform: rotate(45deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
        }

        /* 玩家瓶回到初始位置动画 */
        @keyframes bottle-return {
            0% { 
                transform: rotate(45deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            50% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            100% { 
                transform: rotate(12deg) translateX(0) translateY(0); 
            }
        }

        /* 倒水液体流动动画 */
        @keyframes liquid-pour {
            0% { 
                opacity: 0; 
                transform: translateY(0) scaleY(0); 
            }
            20% { 
                opacity: 1; 
                transform: translateY(0) scaleY(0.3); 
            }
            80% { 
                opacity: 1; 
                transform: translateY(0) scaleY(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(10px) scaleY(1); 
            }
        }

        .animate-bounce-scale {
            animation: bounce-scale 1s ease-out forwards;
        }

        .animate-gift-open {
            animation: gift-open 0.8s ease-out forwards;
        }

        .animate-fly-up {
            animation: fly-up 1s ease-out forwards;
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            pointer-events: none;
        }

        .success-text {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #10b981;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: fly-up 2s ease-out forwards;
        }

        #app {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-gray-100 m-0 p-0">
    <div id="app" class="bg-gray-100 relative w-full max-w-md mx-auto h-screen flex flex-col">

        <!-- 顶部信息栏 -->
        <div class="flex justify-between items-center p-4 bg-white shadow-sm border-b border-gray-200 relative z-10">
            <h1 class="text-lg font-medium text-gray-800">幸运一滴</h1>
            <div id="points-display" class="text-gray-600 font-medium">积分：1200</div>
            <button class="p-1">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="text-gray-500">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- 主游戏区域 -->
        <div id="game-area" class="flex-1 p-4 relative">
            <!-- 游戏提示 -->
            <div id="game-hint" class="text-center mb-6 hidden">
                <div class="inline-block bg-blue-500 text-white px-3 py-1.5 rounded-full text-xs animate-pulse">
                    等待第<span id="current-layer-hint">1</span>层变成<span id="hint-color" class="font-bold">红色</span>时点击屏幕！
                </div>
                <!-- 倒计时进度条 -->
                <div class="mt-4 max-w-xs mx-auto">
                    <div class="bg-gray-300 rounded-full h-2 overflow-hidden">
                        <div id="countdown-bar"
                            class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full transition-all duration-100"
                            style="width: 100%;"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">颜色切换倒计时</div>
                </div>
            </div>

            <!-- 游戏容器 -->
            <div class="flex items-center justify-between gap-4 px-4 h-64">
                <!-- 左侧：倾斜的玩家瓶 -->
                <div class="relative flex-shrink-0">
                    <div class="text-sm text-gray-500 mb-2 text-center">倾斜的玩家瓶</div>
                    <div id="player-bottle-container" class="relative rotate-12">
                        <div
                            class="w-16 h-32 bg-white border-2 border-gray-300 rounded-lg relative overflow-hidden shadow-md">
                            <div
                                class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-4 bg-gray-200 border border-gray-300 rounded-t-lg">
                            </div>
                            <div id="player-bottle-liquid"
                                class="absolute bottom-0 w-full h-24 rounded-b-lg transition-all duration-300"
                                style="background-color: #ef4444;"></div>
                            <div id="player-bottle-text"
                                class="absolute bottom-6 left-2 right-2 text-xs text-white text-center font-medium">红水
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 箭头 -->
                <div class="flex flex-col items-center">
                    <div class="text-2xl text-gray-400">→</div>
                    <div id="pouring-text" class="text-xs text-gray-500 mt-1 animate-bounce hidden">倒入中...</div>
                </div>

                <!-- 右侧：目标瓶 -->
                <div class="relative flex-shrink-0">
                    <div class="text-sm text-gray-500 mb-2 text-center">目标瓶</div>
                    <div class="relative cursor-pointer" id="target-bottle">
                        <div
                            class="bottle-container w-20 h-40 bg-white border-2 rounded-lg relative overflow-hidden shadow-md transition-all duration-300 border-gray-300">
                            <div
                                class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-10 h-5 bg-gray-200 border border-gray-300 rounded-t-lg">
                            </div>

                            <!-- 第二层（顶层） -->
                            <div id="layer-2" class="absolute w-full transition-all duration-300 hidden"
                                style="bottom: 40px; height: 40px; background-color: #3b82f6;">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-white text-base font-bold">2</div>
                                </div>
                            </div>

                            <!-- 第一层（底层） -->
                            <div id="layer-1" class="absolute w-full transition-all duration-300"
                                style="bottom: 0px; height: 40px; background-color: #ef4444;">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-white text-base font-bold">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-center mt-2 text-gray-600">
                            <div>进度: <span id="layer-progress">1/2</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 倒水动画 -->
            <div id="pouring-animation" class="absolute top-32 right-16 hidden">
                <div id="pouring-liquid" class="w-2 h-16 rounded-full opacity-80 transform-gpu"
                    style="background-color: #ef4444; transform-origin: top center;"></div>
                <!-- 添加水滴效果 -->
                <div id="water-drops" class="absolute top-16 left-0 w-2">
                    <div class="w-1 h-1 bg-current rounded-full opacity-60 animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-1 h-1 bg-current rounded-full opacity-40 animate-bounce mt-1" style="animation-delay: 0.3s;"></div>
                </div>
            </div>

            <!-- 宝箱区域 -->
            <div id="chest-area" class="flex justify-center mt-8">
                <div class="flex flex-col items-center">
                    <div id="chest-icon" class="transition-transform duration-300">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" class="text-gray-400">
                            <polyline points="20,12 20,22 4,22 4,12" />
                            <rect x="2" y="7" width="20" height="5" />
                            <line x1="12" y1="22" x2="12" y2="7" />
                            <path d="m5,7 0,-2c0,-1.1 0.9,-2 2,-2h10c1.1,0 2,0.9 2,2v2" />
                        </svg>
                        <div class="text-xs text-gray-500 mt-2">[宝箱]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 固定定位的UI元素 -->
    <!-- 彩带效果容器 -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-30 overflow-hidden hidden"></div>

    <!-- 底部提示 -->
    <div id="click-hint" class="fixed bottom-8 left-0 right-0 text-center hidden z-25">
        <div class="bg-black/70 text-white px-6 py-3 rounded-full mx-8">
            <div class="text-sm">点击屏幕倒水到目标瓶</div>
        </div>
    </div>

    <!-- 颜色变化指示器 -->
    <div id="color-indicator" class="fixed top-24 right-4 flex flex-col gap-1 hidden z-25">
        <div class="text-xs text-gray-500 mb-1">颜色循环</div>
        <div id="color-red"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-125 border-white shadow-lg"
            style="background-color: #ef4444;"></div>
        <div id="color-yellow"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60"
            style="background-color: #eab308;"></div>
        <div id="color-blue"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60"
            style="background-color: #3b82f6;"></div>
    </div>

    <!-- 游戏状态覆盖层 -->
    <!-- 等待开始 -->
    <div id="waiting-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">准备开始</h2>
            <p class="text-gray-600 mb-6 text-sm">
                你的瓶子是<span id="player-color-text" class="font-bold"
                    style="color: #ef4444">红色</span>，当目标瓶当前层变成相同颜色时点击屏幕倒水！需要完成两层挑战才能获胜。
            </p>
            <button id="start-btn"
                class="px-8 py-3 rounded-xl font-bold transition-all bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white shadow-lg">
                开始挑战 (-10积分)
            </button>
        </div>
    </div>

    <!-- 失败状态 -->
    <div id="failed-overlay" class="fixed inset-0 bg-red-900/50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl">
            <div class="text-6xl mb-4">💥</div>
            <h2 class="text-xl font-bold mb-2 text-red-600">时机不对！</h2>
            <p id="failed-message" class="text-gray-600 mb-6 text-sm">
                目标是<span id="target-color-failed" class="font-bold">红色</span>，你倒的是<span id="player-color-failed"
                    class="font-bold">红色</span>
            </p>
            <button id="retry-btn"
                class="px-8 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-xl font-bold transition-all shadow-lg">
                再试一次 (-10积分)
            </button>
        </div>
    </div>

    <!-- 奖励展示状态 -->
    <div id="reward-overlay"
        class="fixed inset-0 bg-gradient-to-br from-yellow-400/20 to-orange-400/20 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl relative overflow-hidden">
            <!-- 庆祝特效 -->
            <div class="absolute inset-0 pointer-events-none">
                <svg class="absolute top-4 left-4 text-yellow-400 animate-pulse" width="20" height="20"
                    viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                <svg class="absolute top-4 right-4 text-orange-400 animate-pulse" width="16" height="16"
                    viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
            </div>

            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-xl font-bold mb-2 text-green-600">挑战成功！</h2>
            <div id="reward-display" class="mb-6">
                <div
                    class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full font-bold text-xl shadow-lg border-2 border-yellow-300">
                    +50 积分!
                </div>
            </div>

            <div class="flex gap-3 justify-center">
                <button id="share-btn"
                    class="flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1" />
                    </svg>
                    <span class="font-bold text-lg">积分 +50</span>
                </button>
            </div>

            <button id="continue-btn"
                class="w-full px-8 py-3 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white rounded-xl font-bold transition-all shadow-lg mt-4">
                再次挑战 (-10积分)
            </button>
        </div>
    </div>

    <!-- 礼盒动画容器 -->
    <div id="gift-box-container" class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none hidden">
        <div class="relative flex flex-col items-center">
            <!-- 主要奖励显示区域 -->
            <div id="flying-reward" class="mb-8 animate-fly-up hidden">
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl text-center">
                    <div class="text-4xl font-black mb-2">🎉</div>
                    <div class="text-3xl font-black">+88 积分!</div>
                </div>
            </div>

            <!-- 礼盒区域 -->
            <div class="relative">
                <!-- 礼盒关闭状态 -->
                <div id="gift-box-closed" class="animate-bounce-scale">
                    <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg shadow-xl relative cursor-pointer">
                        <div class="absolute top-8 left-0 right-0 h-3 bg-yellow-400"></div>
                        <div class="absolute left-8 top-0 bottom-0 w-3 bg-yellow-400"></div>
                        <div class="absolute -top-1.5 left-1/2 transform -translate-x-1/2">
                            <div class="w-6 h-4 bg-red-600 rounded-full relative">
                                <div class="absolute -left-1.5 top-0.5 w-4 h-3 bg-red-600 rounded-full"></div>
                                <div class="absolute -right-1.5 top-0.5 w-4 h-3 bg-red-600 rounded-full"></div>
                            </div>
                        </div>
                        <div class="absolute -inset-3 bg-gradient-to-r from-yellow-400/40 to-orange-400/40 rounded-full animate-ping"></div>
                    </div>
                </div>

                <!-- 礼盒开启状态 -->
                <div id="gift-box-opened" class="animate-gift-open hidden">
                    <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg shadow-xl relative">
                        <div class="absolute inset-2 bg-white rounded-lg flex items-center justify-center">
                            <div class="text-xl">🎁</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 倒计时显示 - 缩小并移到底部 -->
            <div id="countdown-display" class="mt-6 text-center">
                <div class="text-white font-medium text-sm animate-pulse mb-2">点击开启！</div>
                <div class="bg-black/40 rounded-lg px-3 py-1 flex items-center justify-center gap-1">
                    <div class="text-yellow-400 font-bold text-sm" id="countdown-text">3</div>
                    <div class="text-white text-xs">秒后自动开启</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('JavaScript is loading...');

        // 游戏状态和变量
        let gameState = 'waiting';
        let playerColor = 'red';
        let currentLayer = 1;
        let layerColors = ['red', 'yellow'];
        let completedLayerColors = [];
        let currentLayerColor = 'red';
        let colorIndex = 0;
        let points = 1200;
        let reward = null;
        let isAnimating = false;
        let colorTimer = null;
        let countdownTimer = null;

        // 颜色配置
        const colors = ['red', 'yellow', 'blue'];
        const colorMap = {
            'red': '#ef4444',
            'yellow': '#eab308',
            'blue': '#3b82f6'
        };
        const colorNames = {
            'red': '红色',
            'yellow': '黄色',
            'blue': '蓝色'
        };

        // 奖励配置
        const rewards = [
            { type: 'points', amount: 1, name: '积分 +1', rarity: 'common' },
            { type: 'points', amount: 10, name: '积分 +10', rarity: 'common' },
            { type: 'points', amount: 18, name: '积分 +18', rarity: 'rare' },
            { type: 'points', amount: 38, name: '积分 +38', rarity: 'rare' },
            { type: 'points', amount: 88, name: '积分 +88', rarity: 'epic' },
            { type: 'points', amount: 188, name: '积分 +188', rarity: 'epic' },
            { type: 'points', amount: 388, name: '积分 +388', rarity: 'legendary' }
        ];

        // DOM 元素
        const elements = {
            pointsDisplay: document.getElementById('points-display'),
            waitingOverlay: document.getElementById('waiting-overlay'),
            failedOverlay: document.getElementById('failed-overlay'),
            rewardOverlay: document.getElementById('reward-overlay'),
            gameArea: document.getElementById('game-area'),
            gameHint: document.getElementById('game-hint'),
            clickHint: document.getElementById('click-hint'),
            colorIndicator: document.getElementById('color-indicator'),
            startBtn: document.getElementById('start-btn'),
            retryBtn: document.getElementById('retry-btn'),
            continueBtn: document.getElementById('continue-btn'),
            shareBtn: document.getElementById('share-btn'),
            playerColorText: document.getElementById('player-color-text'),
            hintColor: document.getElementById('hint-color'),
            playerBottleLiquid: document.getElementById('player-bottle-liquid'),
            playerBottleText: document.getElementById('player-bottle-text'),
            targetBottle: document.getElementById('target-bottle'),
            layer1: document.getElementById('layer-1'),
            layer2: document.getElementById('layer-2'),
            layerProgress: document.getElementById('layer-progress'),
            pouringAnimation: document.getElementById('pouring-animation'),
            pouringLiquid: document.getElementById('pouring-liquid'),
            pouringText: document.getElementById('pouring-text'),
            confettiContainer: document.getElementById('confetti-container'),
            giftBoxContainer: document.getElementById('gift-box-container'),
            rewardDisplay: document.getElementById('reward-display'),
            countdownBar: document.getElementById('countdown-bar'),
            currentLayerHint: document.getElementById('current-layer-hint'),
            failedMessage: document.getElementById('failed-message'),
            targetColorFailed: document.getElementById('target-color-failed'),
            playerColorFailed: document.getElementById('player-color-failed')
        };

        // 随机选择玩家瓶颜色
        function randomizePlayerColor() {
            const randomIndex = Math.floor(Math.random() * colors.length);
            playerColor = colors[randomIndex];
            updatePlayerColor();
            console.log('Player color randomized to:', playerColor);
        }

        // 更新玩家瓶颜色显示
        function updatePlayerColor() {
            const colorValue = colorMap[playerColor];
            const colorName = colorNames[playerColor];

            elements.playerBottleLiquid.style.backgroundColor = colorValue;
            elements.playerBottleText.textContent = colorName.replace('色', '') + '水';
            elements.playerColorText.textContent = colorName;
            elements.playerColorText.style.color = colorValue;
            elements.pouringLiquid.style.backgroundColor = colorValue;
        }

        // 动态颜色刷新系统
        function refreshPlayerColor() {
            // 随机选择一个新的颜色，确保与当前颜色不同
            const availableColors = colors.filter(color => color !== playerColor);
            const newColor = availableColors[Math.floor(Math.random() * availableColors.length)];
            
            playerColor = newColor;
            updatePlayerColor();
            showColorChangeNotification();
            console.log('Player color refreshed to:', playerColor);
        }

        // 颜色变化通知系统（优化版）
        function showColorChangeNotification() {
            // 获取玩家瓶子的位置
            const playerBottleContainer = document.getElementById('player-bottle-container');
            const rect = playerBottleContainer.getBoundingClientRect();
            
            const notification = document.createElement('div');
            notification.className = 'fixed bg-white text-gray-800 px-3 py-2 rounded-lg font-medium text-sm shadow-lg border-2 z-50 transition-all duration-300';
            notification.style.borderColor = colorMap[playerColor];
            notification.style.left = (rect.left + rect.width / 2) + 'px';
            notification.style.top = (rect.top - 50) + 'px';
            notification.style.transform = 'translateX(-50%)';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${colorMap[playerColor]}"></div>
                    <span>${colorNames[playerColor]}</span>
                </div>
            `;
            
            // 添加冒泡动画
            notification.style.animation = 'bubble-up 0.8s ease-out forwards';
            
            // 0.8秒后自动消失
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => notification.remove(), 200);
            }, 600);
        }

        // 更新积分显示
        function updatePointsDisplay() {
            elements.pointsDisplay.textContent = `积分：${points}`;
        }

        // 更新开始按钮状态
        function updateStartButtonState() {
            if (points >= 10) {
                elements.startBtn.disabled = false;
                elements.startBtn.className = 'px-8 py-3 rounded-xl font-bold transition-all bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white shadow-lg';
                elements.startBtn.textContent = '开始挑战 (-10积分)';
            } else {
                elements.startBtn.disabled = true;
                elements.startBtn.className = 'px-8 py-3 rounded-xl font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
                elements.startBtn.textContent = '积分不足';
            }
        }

        // 更新重试按钮状态
        function updateRetryButtonState() {
            if (points >= 10) {
                elements.retryBtn.disabled = false;
                elements.retryBtn.className = 'px-8 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-xl font-bold transition-all shadow-lg';
                elements.retryBtn.textContent = '再试一次 (-10积分)';
            } else {
                elements.retryBtn.disabled = true;
                elements.retryBtn.className = 'px-8 py-3 bg-gray-300 text-gray-500 rounded-xl font-bold cursor-not-allowed';
                elements.retryBtn.textContent = '积分不足';
            }
        }

        // 开始游戏
        function startGame() {
            if (points < 10) {
                showToast('积分不足，无法开始挑战！');
                return;
            }

            console.log('Starting game...');
            points -= 10;
            updatePointsDisplay();

            // 清理之前的定时器
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }

            // 随机化玩家瓶颜色
            randomizePlayerColor();

            // 重置游戏状态
            gameState = 'playing';
            currentLayer = 1;
            completedLayerColors = [];
            colorIndex = 0;
            currentLayerColor = colors[colorIndex];
            isAnimating = false;  // 重置动画状态

            // 隐藏等待覆盖层
            elements.waitingOverlay.classList.add('hidden');

            // 显示游戏UI
            elements.gameHint.classList.remove('hidden');
            elements.clickHint.classList.remove('hidden');
            elements.colorIndicator.classList.remove('hidden');

            // 随机生成两层目标颜色
            layerColors = [
                colors[Math.floor(Math.random() * colors.length)],
                colors[Math.floor(Math.random() * colors.length)]
            ];

            // 重置层显示
            elements.layer1.classList.remove('hidden');
            elements.layer2.classList.add('hidden');
            elements.layerProgress.textContent = '1/2';

            // 确保层级定位正确
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';

            // 设置初始颜色后再更新层级显示
            elements.layer1.style.backgroundColor = colorMap[currentLayerColor];
            
            // 更新层级显示
            updateLayerDisplay();

            // 更新提示
            updateGameHint();

            // 开始颜色循环
            startColorCycle();

            console.log('Game started successfully');
        }

        // 更新游戏提示
        function updateGameHint() {
            elements.currentLayerHint.textContent = currentLayer;
            elements.hintColor.textContent = colorNames[playerColor];
            elements.hintColor.style.color = colorMap[playerColor];
        }

        // 智能时间控制系统
        function getCurrentColorDuration() {
            if (currentLayerColor === playerColor) {
                return 1000; // 匹配颜色显示1秒
            } else {
                return 500;  // 非匹配颜色显示0.5秒
            }
        }

        // 开始颜色循环
        function startColorCycle() {
            if (colorTimer) {
                clearTimeout(colorTimer);
            }

            // 初始化进度条
            elements.countdownBar.style.width = '100%';

            function cycleColor() {
                if (gameState !== 'playing') return;

                // 切换到下一个颜色
                colorIndex = (colorIndex + 1) % colors.length;
                currentLayerColor = colors[colorIndex];

                // 更新当前层的颜色
                const currentLayerElement = currentLayer === 1 ? elements.layer1 : elements.layer2;
                currentLayerElement.style.backgroundColor = colorMap[currentLayerColor];

                // 更新颜色指示器
                updateColorIndicator();

                // 重置进度条动画
                const duration = getCurrentColorDuration();
                startCountdownAnimation(duration);

                console.log('Color changed to:', currentLayerColor, 'Duration:', duration + 'ms');

                // 使用智能时间控制设置下次切换
                colorTimer = setTimeout(cycleColor, duration);
            }

            // 开始第一次倒计时动画
            const initialDuration = getCurrentColorDuration();
            startCountdownAnimation(initialDuration);
            colorTimer = setTimeout(cycleColor, initialDuration);
        }

        // 开始倒计时动画（支持动态时长）
        function startCountdownAnimation(duration = 2000) {
            // 重置进度条到100%
            elements.countdownBar.style.width = '100%';

            // 使用requestAnimationFrame创建平滑动画
            let startTime = null;

            function animate(currentTime) {
                if (startTime === null) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // 计算当前宽度（从100%到0%）
                const width = (1 - progress) * 100;
                elements.countdownBar.style.width = width + '%';

                // 如果动画未完成且游戏仍在进行，继续动画
                if (progress < 1 && gameState === 'playing') {
                    requestAnimationFrame(animate);
                }
            }

            requestAnimationFrame(animate);
        }

        // 层级状态管理
        function updateLayerDisplay() {
            console.log('Updating layer display - currentLayer:', currentLayer, 'completedLayerColors:', completedLayerColors);
            
            // 确保层级定位始终正确
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';
            
            // 第一层状态
            if (currentLayer > 1) {
                // 已完成层：绿色边框 + 固定颜色 + 移除动画
                elements.layer1.style.borderColor = '#10b981';
                elements.layer1.style.borderWidth = '3px';
                elements.layer1.style.backgroundColor = colorMap[completedLayerColors[0]];
                elements.layer1.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                elements.layer1.style.animation = 'none';
                elements.layer1.style.opacity = '1';
                // 再次确保定位正确
                elements.layer1.style.bottom = '0px';
                elements.layer1.style.height = '40px';
            } else {
                // 当前挑战层：金色边框 + 变化颜色 + 动画效果
                elements.layer1.style.borderColor = '#f59e0b';
                elements.layer1.style.borderWidth = '3px';
                elements.layer1.style.backgroundColor = colorMap[currentLayerColor];
                elements.layer1.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.5)';
                elements.layer1.style.animation = 'layer-pulse 1s ease-in-out infinite alternate';
                elements.layer1.style.opacity = '1';
                // 再次确保定位正确
                elements.layer1.style.bottom = '0px';
                elements.layer1.style.height = '40px';
            }

            // 第二层状态
            if (currentLayer > 2) {
                // 已完成层：绿色边框 + 固定颜色
                elements.layer2.style.borderColor = '#10b981';
                elements.layer2.style.borderWidth = '3px';
                elements.layer2.style.backgroundColor = colorMap[completedLayerColors[1]];
                elements.layer2.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                elements.layer2.style.animation = 'none';
                elements.layer2.style.opacity = '1';
                // 再次确保定位正确
                elements.layer2.style.bottom = '40px';
                elements.layer2.style.height = '40px';
            } else if (currentLayer === 2) {
                // 当前挑战层：金色边框 + 变化颜色 + 动画效果
                elements.layer2.style.borderColor = '#f59e0b';
                elements.layer2.style.borderWidth = '3px';
                elements.layer2.style.backgroundColor = colorMap[currentLayerColor];
                elements.layer2.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.5)';
                elements.layer2.style.animation = 'layer-pulse 1s ease-in-out infinite alternate';
                elements.layer2.style.opacity = '1';
                // 确保第二层可见
                elements.layer2.classList.remove('hidden');
                // 再次确保定位正确
                elements.layer2.style.bottom = '40px';
                elements.layer2.style.height = '40px';
            } else {
                // 未到达层：保持隐藏
                elements.layer2.classList.add('hidden');
            }
        }

        // 更新颜色指示器
        function updateColorIndicator() {
            colors.forEach((color, index) => {
                const indicator = document.getElementById(`color-${color}`);
                if (color === currentLayerColor) {
                    indicator.className = 'w-4 h-4 rounded-full border-2 transition-all duration-200 scale-125 border-white shadow-lg';
                    indicator.style.opacity = '1';
                } else {
                    indicator.className = 'w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60';
                }
            });
        }

        // 颜色匹配逻辑
        function checkLayerMatch() {
            // 简化逻辑：只要当前显示颜色与玩家颜色匹配就成功
            // 这样确保游戏是可以完成的
            return currentLayerColor === playerColor;
        }

        // 处理屏幕点击事件
        function handleScreenClick(event) {
            if (gameState !== 'playing' || isAnimating) return;

            console.log('Screen clicked! Player color:', playerColor, 'Current layer color:', currentLayerColor, 'Target layer color:', layerColors[currentLayer - 1]);

            // 使用双重验证检查匹配
            if (checkLayerMatch()) {
                // 成功匹配
                handleSuccessfulMatch();
            } else {
                // 匹配失败
                handleFailedMatch();
            }
        }

        // 处理成功匹配
        function handleSuccessfulMatch() {
            isAnimating = true;

            // 停止颜色循环
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }

            // 显示倒水动画
            showPouringAnimation();

            // 记录完成的层颜色
            completedLayerColors.push(currentLayerColor);

            setTimeout(() => {
                if (currentLayer === 1) {
                    // 完成第一层，进入第二层
                    currentLayer = 2;
                    elements.layerProgress.textContent = '2/2';

                    // 刷新玩家瓶颜色（动态难度系统）
                    refreshPlayerColor();
                    updateGameHint();

                    // 重新开始颜色循环
                    colorIndex = 0;
                    currentLayerColor = colors[colorIndex];
                    
                    // 更新层级显示（在设置颜色之后）
                    updateLayerDisplay();
                    
                    // 更新颜色指示器
                    updateColorIndicator();

                    isAnimating = false;
                    startColorCycle();

                    console.log('Layer 1 completed, moving to layer 2');
                } else {
                    // 完成第二层，游戏胜利
                    gameState = 'completed';
                    showVictorySequence();
                    console.log('Game completed successfully!');
                }
            }, 1800); // 增加到1800ms以适应新的动画时长
        }

        // 处理匹配失败
        function handleFailedMatch() {
            gameState = 'failed';

            // 停止颜色循环
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }

            // 更新失败消息
            elements.targetColorFailed.textContent = colorNames[currentLayerColor];
            elements.targetColorFailed.style.color = colorMap[currentLayerColor];
            elements.playerColorFailed.textContent = colorNames[playerColor];
            elements.playerColorFailed.style.color = colorMap[playerColor];

            // 显示失败覆盖层
            elements.failedOverlay.classList.remove('hidden');

            // 隐藏游戏UI
            elements.gameHint.classList.add('hidden');
            elements.clickHint.classList.add('hidden');
            elements.colorIndicator.classList.add('hidden');

            // 更新重试按钮状态
            updateRetryButtonState();

            console.log('Game failed - color mismatch');
        }

        // 显示倒水动画
        function showPouringAnimation() {
            const playerBottleContainer = document.getElementById('player-bottle-container');
            
            // 第一阶段：移动到目标位置 (600ms)
            playerBottleContainer.style.animation = 'bottle-move-to-target 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            
            setTimeout(() => {
                // 第二阶段：开始倒水动画 (400ms)
                playerBottleContainer.style.animation = 'bottle-pour 0.4s ease-in-out forwards';
                
                // 显示倒水液体效果
                elements.pouringAnimation.classList.remove('hidden');
                elements.pouringText.classList.remove('hidden');
                
                // 动态计算倒水位置
                const targetBottleRect = elements.targetBottle.getBoundingClientRect();
                const gameAreaRect = elements.gameArea.getBoundingClientRect();
                
                const relativeLeft = ((targetBottleRect.left - gameAreaRect.left) / gameAreaRect.width) * 100;
                const relativeTop = ((targetBottleRect.top - gameAreaRect.top) / gameAreaRect.height) * 100;
                
                elements.pouringAnimation.style.left = relativeLeft + '%';
                elements.pouringAnimation.style.top = (relativeTop - 5) + '%';
                elements.pouringAnimation.style.transform = 'translateX(-50%)';
                
                // 添加液体流动动画
                elements.pouringLiquid.style.animation = 'liquid-pour 0.8s ease-out forwards';
                
                // 在液体开始流动后200ms显示成功提示（更符合视觉逻辑）
                setTimeout(() => {
                    showSuccessText();
                }, 200);
                
                setTimeout(() => {
                    // 第三阶段：回到初始位置 (500ms)
                    playerBottleContainer.style.animation = 'bottle-return 0.5s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards';
                    
                    // 隐藏倒水效果
                    elements.pouringAnimation.classList.add('hidden');
                    elements.pouringText.classList.add('hidden');
                    
                    setTimeout(() => {
                        // 清除动画样式，确保瓶子回到初始状态
                        playerBottleContainer.style.animation = '';
                        elements.pouringLiquid.style.animation = '';
                    }, 500);
                }, 400);
            }, 600);
        }

        // 显示成功文本反馈
        function showSuccessText() {
            const currentLayerElement = currentLayer === 1 ? elements.layer1 : elements.layer2;
            const successText = document.createElement('div');
            successText.className = 'success-text';
            successText.textContent = '成功！';
            // 不要改变层级元素的position，保持absolute定位
            // currentLayerElement.style.position = 'relative'; // 删除这行
            currentLayerElement.appendChild(successText);
            
            setTimeout(() => {
                if (successText.parentNode) {
                    successText.parentNode.removeChild(successText);
                }
            }, 2000);
        }

        // 显示胜利序列
        function showVictorySequence() {
            // 隐藏游戏UI
            elements.gameHint.classList.add('hidden');
            elements.clickHint.classList.add('hidden');
            elements.colorIndicator.classList.add('hidden');

            // 生成奖励
            reward = generateReward();

            // 显示礼盒动画
            showGiftBoxAnimation();
        }

        // 生成奖励
        function generateReward() {
            const rand = Math.random();
            if (rand < 0.35) return rewards[0]; // 35% - 1 积分
            if (rand < 0.60) return rewards[1]; // 25% - 10 积分
            if (rand < 0.75) return rewards[2]; // 15% - 18 积分
            if (rand < 0.85) return rewards[3]; // 10% - 38 积分
            if (rand < 0.93) return rewards[4]; // 8% - 88 积分
            if (rand < 0.98) return rewards[5]; // 5% - 188 积分
            return rewards[6]; // 2% - 388 积分
        }

        // 显示礼盒动画
        function showGiftBoxAnimation() {
            elements.giftBoxContainer.classList.remove('hidden');
            elements.giftBoxContainer.style.pointerEvents = 'auto';

            // 3秒后自动开启
            let countdownSeconds = 3;
            const countdownText = document.getElementById('countdown-text');

            countdownTimer = setInterval(() => {
                countdownSeconds--;
                countdownText.textContent = countdownSeconds;

                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    openGiftBox();
                }
            }, 1000);

            // 点击开启
            const giftBoxClosed = document.getElementById('gift-box-closed');
            giftBoxClosed.addEventListener('click', (e) => {
                e.stopPropagation();
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    openGiftBox();
                }
            });
        }

        // 开启礼盒
        function openGiftBox() {
            if (reward) {
                const rewardText = `+${reward.amount} 积分!`;
                // 更新奖励文本显示
                const rewardTextElement = document.getElementById('flying-reward').querySelector('div div:last-child');
                rewardTextElement.textContent = rewardText;

                // 切换到开启状态
                document.getElementById('gift-box-closed').classList.add('hidden');
                document.getElementById('gift-box-opened').classList.remove('hidden');
                document.getElementById('flying-reward').classList.remove('hidden');

                // 显示彩带效果
                showConfettiEffect();

                // 2秒后显示奖励界面
                setTimeout(() => {
                    hideGiftBoxAnimation();
                    showRewardOverlay();
                }, 2000);
            }
        }

        // 隐藏礼盒动画
        function hideGiftBoxAnimation() {
            elements.giftBoxContainer.classList.add('hidden');
            elements.giftBoxContainer.style.pointerEvents = 'none';
        }

        // 显示奖励覆盖层
        function showRewardOverlay() {
            if (reward) {
                // 更新奖励显示
                elements.rewardDisplay.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full font-bold text-xl shadow-lg border-2 border-yellow-300">
                        +${reward.amount} 积分!
                    </div>
                `;

                // 增加积分
                points += reward.amount;
                updatePointsDisplay();

                // 显示奖励覆盖层
                elements.rewardOverlay.classList.remove('hidden');
            }
        }

        // 显示彩带效果
        function showConfettiEffect() {
            elements.confettiContainer.classList.remove('hidden');

            // 获取目标瓶子的位置
            const targetBottle = elements.targetBottle;
            const bottleRect = targetBottle.getBoundingClientRect();
            const containerRect = elements.confettiContainer.getBoundingClientRect();

            // 计算目标瓶子在容器中的相对位置
            const centerX = (bottleRect.left + bottleRect.width / 2 - containerRect.left) / containerRect.width * 100;
            const centerY = (bottleRect.top + bottleRect.height / 2 - containerRect.top) / containerRect.height * 100;

            // 创建彩带片段
            for (let i = 0; i < 40; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';

                // 随机颜色
                const colorIndex = Math.floor(Math.random() * colors.length);
                const colorValue = colorMap[colors[colorIndex]];
                confetti.style.backgroundColor = colorValue;

                // 从瓶子中心位置开始
                confetti.style.left = centerX + '%';
                confetti.style.top = centerY + '%';

                // 随机爆炸方向和距离
                const angle = (Math.PI * 2 * i) / 40 + (Math.random() - 0.5) * 0.5;
                const distance = 50 + Math.random() * 100;
                const endX = centerX + Math.cos(angle) * distance / containerRect.width * 100;
                const endY = centerY + Math.sin(angle) * distance / containerRect.height * 100 + Math.random() * 50;

                // 设置CSS变量用于动画
                confetti.style.setProperty('--end-x', endX + '%');
                confetti.style.setProperty('--end-y', endY + '%');
                confetti.style.setProperty('--rotation', Math.random() * 720 + 'deg');
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                confetti.style.animation = 'confettiBurst 2s ease-out forwards';

                elements.confettiContainer.appendChild(confetti);
            }

            // 2秒后清理彩带
            setTimeout(() => {
                elements.confettiContainer.innerHTML = '';
                elements.confettiContainer.classList.add('hidden');
            }, 2000);
        }

        // 重置游戏
        function resetGame() {
            if (points < 10) {
                showToast('积分不足，无法重新开始！');
                return;
            }

            // 隐藏失败覆盖层
            elements.failedOverlay.classList.add('hidden');

            // 重新开始游戏
            startGame();
        }

        // 开始新挑战
        function startNewChallenge() {
            if (points < 10) {
                showToast('积分不足，无法开始挑战！');
                return;
            }

            // 隐藏奖励界面
            elements.rewardOverlay.classList.add('hidden');

            // 重新开始游戏
            startGame();
        }

        // 分享结果
        function shareResult() {
            if (reward) {
                const shareText = `🎉 我在幸运一滴游戏中获得了${reward.name}！当前积分：${points} 分！快来挑战吧！`;

                if (navigator.share) {
                    navigator.share({
                        title: '幸运一滴游戏',
                        text: shareText,
                        url: window.location.href
                    });
                } else {
                    // 复制到剪贴板
                    navigator.clipboard.writeText(shareText).then(() => {
                        showToast('分享内容已复制到剪贴板！');
                    });
                }
            }
        }

        // 显示提示消息
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full z-50 transition-opacity';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        // 初始化游戏
        function initGame() {
            console.log('Initializing game...');

            // 确保层级定位正确
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';

            // 随机化初始玩家瓶颜色
            randomizePlayerColor();

            // 更新按钮状态
            updateStartButtonState();
            updatePointsDisplay();

            // 设置事件监听器
            elements.startBtn.addEventListener('click', startGame);
            elements.retryBtn.addEventListener('click', resetGame);
            elements.continueBtn.addEventListener('click', startNewChallenge);
            elements.shareBtn.addEventListener('click', shareResult);

            // 为目标瓶和游戏区域添加点击事件
            elements.targetBottle.addEventListener('click', handleScreenClick);
            elements.gameArea.addEventListener('click', handleScreenClick);

            console.log('Game initialized successfully');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', initGame);

        console.log('JavaScript loaded successfully');
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿ä¸€æ»´ - Lucky Drop Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(0) rotate(0deg) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(200px) rotate(360deg) scale(0.5);
            }
        }

        @keyframes confettiBurst {
            0% {
                opacity: 1;
                transform: translate(0, 0) rotate(0deg) scale(1);
            }

            20% {
                opacity: 1;
                transform: translate(calc(var(--end-x) - 50%), calc(var(--end-y) - 50%)) rotate(calc(var(--rotation) * 0.3)) scale(1.2);
            }

            100% {
                opacity: 0;
                transform: translate(calc(var(--end-x) - 50%), calc(var(--end-y) - 50% + 100px)) rotate(var(--rotation)) scale(0.3);
            }
        }

        @keyframes bounce-scale {
            0% {
                opacity: 0;
                transform: scale(0.3) translateY(-50px);
            }

            50% {
                opacity: 1;
                transform: scale(1.1) translateY(0);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes gift-open {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.1);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes fly-up {
            0% {
                opacity: 0;
                transform: translateY(0px) scale(0.3);
            }

            50% {
                opacity: 1;
                transform: translateY(-10px) scale(1.1);
            }

            100% {
                opacity: 1;
                transform: translateY(-20px) scale(1);
            }
        }

        /* å±‚çº§è„‰å†²åŠ¨ç”» */
        @keyframes layer-pulse {
            0% { 
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
            }
            100% { 
                box-shadow: 0 0 25px rgba(251, 191, 36, 0.8);
            }
        }

        /* æ°´æ³¢çº¹æ•ˆæœ */
        @keyframes water-flow {
            0% { left: -100%; opacity: 0.8; }
            50% { opacity: 1; }
            100% { left: 100%; opacity: 0.8; }
        }

        /* å†’æ³¡åŠ¨ç”» */
        @keyframes bubble-up {
            0% { 
                opacity: 0; 
                transform: translateX(-50%) translateY(10px) scale(0.8); 
            }
            50% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(-5px) scale(1.05); 
            }
            100% { 
                opacity: 1; 
                transform: translateX(-50%) translateY(0px) scale(1); 
            }
        }

        /* ç©å®¶ç“¶ç§»åŠ¨åˆ°ç›®æ ‡ä½ç½®åŠ¨ç”» */
        @keyframes bottle-move-to-target {
            0% { 
                transform: rotate(12deg) translateX(0) translateY(0); 
            }
            100% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
        }

        /* ç©å®¶ç“¶å€’æ°´åŠ¨ç”»ï¼ˆå€¾æ–œæ›´å¤šï¼‰ */
        @keyframes bottle-pour {
            0% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            100% { 
                transform: rotate(45deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
        }

        /* ç©å®¶ç“¶å›åˆ°åˆå§‹ä½ç½®åŠ¨ç”» */
        @keyframes bottle-return {
            0% { 
                transform: rotate(45deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            50% { 
                transform: rotate(12deg) translateX(min(120px, 30vw)) translateY(-20px); 
            }
            100% { 
                transform: rotate(12deg) translateX(0) translateY(0); 
            }
        }

        /* å€’æ°´æ¶²ä½“æµåŠ¨åŠ¨ç”» */
        @keyframes liquid-pour {
            0% { 
                opacity: 0; 
                transform: translateY(0) scaleY(0); 
            }
            20% { 
                opacity: 1; 
                transform: translateY(0) scaleY(0.3); 
            }
            80% { 
                opacity: 1; 
                transform: translateY(0) scaleY(1); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(10px) scaleY(1); 
            }
        }

        .animate-bounce-scale {
            animation: bounce-scale 1s ease-out forwards;
        }

        .animate-gift-open {
            animation: gift-open 0.8s ease-out forwards;
        }

        .animate-fly-up {
            animation: fly-up 1s ease-out forwards;
        }

        .confetti-piece {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 2px;
            pointer-events: none;
        }

        .success-text {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #10b981;
            font-weight: bold;
            font-size: 14px;
            pointer-events: none;
            animation: fly-up 2s ease-out forwards;
        }

        #app {
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-gray-100 m-0 p-0">
    <div id="app" class="bg-gray-100 relative w-full max-w-md mx-auto h-screen flex flex-col">

        <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
        <div class="flex justify-between items-center p-4 bg-white shadow-sm border-b border-gray-200 relative z-10">
            <h1 class="text-lg font-medium text-gray-800">å¹¸è¿ä¸€æ»´</h1>
            <div id="points-display" class="text-gray-600 font-medium">ç§¯åˆ†ï¼š1200</div>
            <button class="p-1">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    class="text-gray-500">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>

        <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
        <div id="game-area" class="flex-1 p-4 relative">
            <!-- æ¸¸æˆæç¤º -->
            <div id="game-hint" class="text-center mb-6 hidden">
                <div class="inline-block bg-blue-500 text-white px-3 py-1.5 rounded-full text-xs animate-pulse">
                    ç­‰å¾…ç¬¬<span id="current-layer-hint">1</span>å±‚å˜æˆ<span id="hint-color" class="font-bold">çº¢è‰²</span>æ—¶ç‚¹å‡»å±å¹•ï¼
                </div>
                <!-- å€’è®¡æ—¶è¿›åº¦æ¡ -->
                <div class="mt-4 max-w-xs mx-auto">
                    <div class="bg-gray-300 rounded-full h-2 overflow-hidden">
                        <div id="countdown-bar"
                            class="bg-gradient-to-r from-green-400 to-blue-500 h-full rounded-full transition-all duration-100"
                            style="width: 100%;"></div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">é¢œè‰²åˆ‡æ¢å€’è®¡æ—¶</div>
                </div>
            </div>

            <!-- æ¸¸æˆå®¹å™¨ -->
            <div class="flex items-center justify-between gap-4 px-4 h-64">
                <!-- å·¦ä¾§ï¼šå€¾æ–œçš„ç©å®¶ç“¶ -->
                <div class="relative flex-shrink-0">
                    <div class="text-sm text-gray-500 mb-2 text-center">å€¾æ–œçš„ç©å®¶ç“¶</div>
                    <div id="player-bottle-container" class="relative rotate-12">
                        <div
                            class="w-16 h-32 bg-white border-2 border-gray-300 rounded-lg relative overflow-hidden shadow-md">
                            <div
                                class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-4 bg-gray-200 border border-gray-300 rounded-t-lg">
                            </div>
                            <div id="player-bottle-liquid"
                                class="absolute bottom-0 w-full h-24 rounded-b-lg transition-all duration-300"
                                style="background-color: #ef4444;"></div>
                            <div id="player-bottle-text"
                                class="absolute bottom-6 left-2 right-2 text-xs text-white text-center font-medium">çº¢æ°´
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç®­å¤´ -->
                <div class="flex flex-col items-center">
                    <div class="text-2xl text-gray-400">â†’</div>
                    <div id="pouring-text" class="text-xs text-gray-500 mt-1 animate-bounce hidden">å€’å…¥ä¸­...</div>
                </div>

                <!-- å³ä¾§ï¼šç›®æ ‡ç“¶ -->
                <div class="relative flex-shrink-0">
                    <div class="text-sm text-gray-500 mb-2 text-center">ç›®æ ‡ç“¶</div>
                    <div class="relative cursor-pointer" id="target-bottle">
                        <div
                            class="bottle-container w-20 h-40 bg-white border-2 rounded-lg relative overflow-hidden shadow-md transition-all duration-300 border-gray-300">
                            <div
                                class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-10 h-5 bg-gray-200 border border-gray-300 rounded-t-lg">
                            </div>

                            <!-- ç¬¬äºŒå±‚ï¼ˆé¡¶å±‚ï¼‰ -->
                            <div id="layer-2" class="absolute w-full transition-all duration-300 hidden"
                                style="bottom: 40px; height: 40px; background-color: #3b82f6;">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-white text-base font-bold">2</div>
                                </div>
                            </div>

                            <!-- ç¬¬ä¸€å±‚ï¼ˆåº•å±‚ï¼‰ -->
                            <div id="layer-1" class="absolute w-full transition-all duration-300"
                                style="bottom: 0px; height: 40px; background-color: #ef4444;">
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <div class="text-white text-base font-bold">1</div>
                                </div>
                            </div>
                        </div>
                        <div class="text-xs text-center mt-2 text-gray-600">
                            <div>è¿›åº¦: <span id="layer-progress">1/2</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€’æ°´åŠ¨ç”» -->
            <div id="pouring-animation" class="absolute top-32 right-16 hidden">
                <div id="pouring-liquid" class="w-2 h-16 rounded-full opacity-80 transform-gpu"
                    style="background-color: #ef4444; transform-origin: top center;"></div>
                <!-- æ·»åŠ æ°´æ»´æ•ˆæœ -->
                <div id="water-drops" class="absolute top-16 left-0 w-2">
                    <div class="w-1 h-1 bg-current rounded-full opacity-60 animate-bounce" style="animation-delay: 0.1s;"></div>
                    <div class="w-1 h-1 bg-current rounded-full opacity-40 animate-bounce mt-1" style="animation-delay: 0.3s;"></div>
                </div>
            </div>

            <!-- å®ç®±åŒºåŸŸ -->
            <div id="chest-area" class="flex justify-center mt-8">
                <div class="flex flex-col items-center">
                    <div id="chest-icon" class="transition-transform duration-300">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" class="text-gray-400">
                            <polyline points="20,12 20,22 4,22 4,12" />
                            <rect x="2" y="7" width="20" height="5" />
                            <line x1="12" y1="22" x2="12" y2="7" />
                            <path d="m5,7 0,-2c0,-1.1 0.9,-2 2,-2h10c1.1,0 2,0.9 2,2v2" />
                        </svg>
                        <div class="text-xs text-gray-500 mt-2">[å®ç®±]</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›ºå®šå®šä½çš„UIå…ƒç´  -->
    <!-- å½©å¸¦æ•ˆæœå®¹å™¨ -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-30 overflow-hidden hidden"></div>

    <!-- åº•éƒ¨æç¤º -->
    <div id="click-hint" class="fixed bottom-8 left-0 right-0 text-center hidden z-25">
        <div class="bg-black/70 text-white px-6 py-3 rounded-full mx-8">
            <div class="text-sm">ç‚¹å‡»å±å¹•å€’æ°´åˆ°ç›®æ ‡ç“¶</div>
        </div>
    </div>

    <!-- é¢œè‰²å˜åŒ–æŒ‡ç¤ºå™¨ -->
    <div id="color-indicator" class="fixed top-24 right-4 flex flex-col gap-1 hidden z-25">
        <div class="text-xs text-gray-500 mb-1">é¢œè‰²å¾ªç¯</div>
        <div id="color-red"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-125 border-white shadow-lg"
            style="background-color: #ef4444;"></div>
        <div id="color-yellow"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60"
            style="background-color: #eab308;"></div>
        <div id="color-blue"
            class="w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60"
            style="background-color: #3b82f6;"></div>
    </div>

    <!-- æ¸¸æˆçŠ¶æ€è¦†ç›–å±‚ -->
    <!-- ç­‰å¾…å¼€å§‹ -->
    <div id="waiting-overlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-40">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl">
            <h2 class="text-xl font-bold mb-4 text-gray-800">å‡†å¤‡å¼€å§‹</h2>
            <p class="text-gray-600 mb-6 text-sm">
                ä½ çš„ç“¶å­æ˜¯<span id="player-color-text" class="font-bold"
                    style="color: #ef4444">çº¢è‰²</span>ï¼Œå½“ç›®æ ‡ç“¶å½“å‰å±‚å˜æˆç›¸åŒé¢œè‰²æ—¶ç‚¹å‡»å±å¹•å€’æ°´ï¼éœ€è¦å®Œæˆä¸¤å±‚æŒ‘æˆ˜æ‰èƒ½è·èƒœã€‚
            </p>
            <button id="start-btn"
                class="px-8 py-3 rounded-xl font-bold transition-all bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white shadow-lg">
                å¼€å§‹æŒ‘æˆ˜ (-10ç§¯åˆ†)
            </button>
        </div>
    </div>

    <!-- å¤±è´¥çŠ¶æ€ -->
    <div id="failed-overlay" class="fixed inset-0 bg-red-900/50 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl">
            <div class="text-6xl mb-4">ğŸ’¥</div>
            <h2 class="text-xl font-bold mb-2 text-red-600">æ—¶æœºä¸å¯¹ï¼</h2>
            <p id="failed-message" class="text-gray-600 mb-6 text-sm">
                ç›®æ ‡æ˜¯<span id="target-color-failed" class="font-bold">çº¢è‰²</span>ï¼Œä½ å€’çš„æ˜¯<span id="player-color-failed"
                    class="font-bold">çº¢è‰²</span>
            </p>
            <button id="retry-btn"
                class="px-8 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-xl font-bold transition-all shadow-lg">
                å†è¯•ä¸€æ¬¡ (-10ç§¯åˆ†)
            </button>
        </div>
    </div>

    <!-- å¥–åŠ±å±•ç¤ºçŠ¶æ€ -->
    <div id="reward-overlay"
        class="fixed inset-0 bg-gradient-to-br from-yellow-400/20 to-orange-400/20 flex items-center justify-center z-40 hidden">
        <div class="bg-white rounded-2xl p-8 mx-4 text-center shadow-xl relative overflow-hidden">
            <!-- åº†ç¥ç‰¹æ•ˆ -->
            <div class="absolute inset-0 pointer-events-none">
                <svg class="absolute top-4 left-4 text-yellow-400 animate-pulse" width="20" height="20"
                    viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
                <svg class="absolute top-4 right-4 text-orange-400 animate-pulse" width="16" height="16"
                    viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
            </div>

            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-xl font-bold mb-2 text-green-600">æŒ‘æˆ˜æˆåŠŸï¼</h2>
            <div id="reward-display" class="mb-6">
                <div
                    class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full font-bold text-xl shadow-lg border-2 border-yellow-300">
                    +50 ç§¯åˆ†!
                </div>
            </div>

            <div class="flex gap-3 justify-center">
                <button id="share-btn"
                    class="flex items-center gap-2 px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1" />
                    </svg>
                    <span class="font-bold text-lg">ç§¯åˆ† +50</span>
                </button>
            </div>

            <button id="continue-btn"
                class="w-full px-8 py-3 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white rounded-xl font-bold transition-all shadow-lg mt-4">
                å†æ¬¡æŒ‘æˆ˜ (-10ç§¯åˆ†)
            </button>
        </div>
    </div>

    <!-- ç¤¼ç›’åŠ¨ç”»å®¹å™¨ -->
    <div id="gift-box-container" class="fixed inset-0 flex items-center justify-center z-50 pointer-events-none hidden">
        <div class="relative flex flex-col items-center">
            <!-- ä¸»è¦å¥–åŠ±æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="flying-reward" class="mb-8 animate-fly-up hidden">
                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl text-center">
                    <div class="text-4xl font-black mb-2">ğŸ‰</div>
                    <div class="text-3xl font-black">+88 ç§¯åˆ†!</div>
                </div>
            </div>

            <!-- ç¤¼ç›’åŒºåŸŸ -->
            <div class="relative">
                <!-- ç¤¼ç›’å…³é—­çŠ¶æ€ -->
                <div id="gift-box-closed" class="animate-bounce-scale">
                    <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-pink-500 rounded-lg shadow-xl relative cursor-pointer">
                        <div class="absolute top-8 left-0 right-0 h-3 bg-yellow-400"></div>
                        <div class="absolute left-8 top-0 bottom-0 w-3 bg-yellow-400"></div>
                        <div class="absolute -top-1.5 left-1/2 transform -translate-x-1/2">
                            <div class="w-6 h-4 bg-red-600 rounded-full relative">
                                <div class="absolute -left-1.5 top-0.5 w-4 h-3 bg-red-600 rounded-full"></div>
                                <div class="absolute -right-1.5 top-0.5 w-4 h-3 bg-red-600 rounded-full"></div>
                            </div>
                        </div>
                        <div class="absolute -inset-3 bg-gradient-to-r from-yellow-400/40 to-orange-400/40 rounded-full animate-ping"></div>
                    </div>
                </div>

                <!-- ç¤¼ç›’å¼€å¯çŠ¶æ€ -->
                <div id="gift-box-opened" class="animate-gift-open hidden">
                    <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg shadow-xl relative">
                        <div class="absolute inset-2 bg-white rounded-lg flex items-center justify-center">
                            <div class="text-xl">ğŸ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å€’è®¡æ—¶æ˜¾ç¤º - ç¼©å°å¹¶ç§»åˆ°åº•éƒ¨ -->
            <div id="countdown-display" class="mt-6 text-center">
                <div class="text-white font-medium text-sm animate-pulse mb-2">ç‚¹å‡»å¼€å¯ï¼</div>
                <div class="bg-black/40 rounded-lg px-3 py-1 flex items-center justify-center gap-1">
                    <div class="text-yellow-400 font-bold text-sm" id="countdown-text">3</div>
                    <div class="text-white text-xs">ç§’åè‡ªåŠ¨å¼€å¯</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('JavaScript is loading...');

        // æ¸¸æˆçŠ¶æ€å’Œå˜é‡
        let gameState = 'waiting';
        let playerColor = 'red';
        let currentLayer = 1;
        let layerColors = ['red', 'yellow'];
        let completedLayerColors = [];
        let currentLayerColor = 'red';
        let colorIndex = 0;
        let points = 1200;
        let reward = null;
        let isAnimating = false;
        let colorTimer = null;
        let countdownTimer = null;

        // é¢œè‰²é…ç½®
        const colors = ['red', 'yellow', 'blue'];
        const colorMap = {
            'red': '#ef4444',
            'yellow': '#eab308',
            'blue': '#3b82f6'
        };
        const colorNames = {
            'red': 'çº¢è‰²',
            'yellow': 'é»„è‰²',
            'blue': 'è“è‰²'
        };

        // å¥–åŠ±é…ç½®
        const rewards = [
            { type: 'points', amount: 1, name: 'ç§¯åˆ† +1', rarity: 'common' },
            { type: 'points', amount: 10, name: 'ç§¯åˆ† +10', rarity: 'common' },
            { type: 'points', amount: 18, name: 'ç§¯åˆ† +18', rarity: 'rare' },
            { type: 'points', amount: 38, name: 'ç§¯åˆ† +38', rarity: 'rare' },
            { type: 'points', amount: 88, name: 'ç§¯åˆ† +88', rarity: 'epic' },
            { type: 'points', amount: 188, name: 'ç§¯åˆ† +188', rarity: 'epic' },
            { type: 'points', amount: 388, name: 'ç§¯åˆ† +388', rarity: 'legendary' }
        ];

        // DOM å…ƒç´ 
        const elements = {
            pointsDisplay: document.getElementById('points-display'),
            waitingOverlay: document.getElementById('waiting-overlay'),
            failedOverlay: document.getElementById('failed-overlay'),
            rewardOverlay: document.getElementById('reward-overlay'),
            gameArea: document.getElementById('game-area'),
            gameHint: document.getElementById('game-hint'),
            clickHint: document.getElementById('click-hint'),
            colorIndicator: document.getElementById('color-indicator'),
            startBtn: document.getElementById('start-btn'),
            retryBtn: document.getElementById('retry-btn'),
            continueBtn: document.getElementById('continue-btn'),
            shareBtn: document.getElementById('share-btn'),
            playerColorText: document.getElementById('player-color-text'),
            hintColor: document.getElementById('hint-color'),
            playerBottleLiquid: document.getElementById('player-bottle-liquid'),
            playerBottleText: document.getElementById('player-bottle-text'),
            targetBottle: document.getElementById('target-bottle'),
            layer1: document.getElementById('layer-1'),
            layer2: document.getElementById('layer-2'),
            layerProgress: document.getElementById('layer-progress'),
            pouringAnimation: document.getElementById('pouring-animation'),
            pouringLiquid: document.getElementById('pouring-liquid'),
            pouringText: document.getElementById('pouring-text'),
            confettiContainer: document.getElementById('confetti-container'),
            giftBoxContainer: document.getElementById('gift-box-container'),
            rewardDisplay: document.getElementById('reward-display'),
            countdownBar: document.getElementById('countdown-bar'),
            currentLayerHint: document.getElementById('current-layer-hint'),
            failedMessage: document.getElementById('failed-message'),
            targetColorFailed: document.getElementById('target-color-failed'),
            playerColorFailed: document.getElementById('player-color-failed')
        };

        // éšæœºé€‰æ‹©ç©å®¶ç“¶é¢œè‰²
        function randomizePlayerColor() {
            const randomIndex = Math.floor(Math.random() * colors.length);
            playerColor = colors[randomIndex];
            updatePlayerColor();
            console.log('Player color randomized to:', playerColor);
        }

        // æ›´æ–°ç©å®¶ç“¶é¢œè‰²æ˜¾ç¤º
        function updatePlayerColor() {
            const colorValue = colorMap[playerColor];
            const colorName = colorNames[playerColor];

            elements.playerBottleLiquid.style.backgroundColor = colorValue;
            elements.playerBottleText.textContent = colorName.replace('è‰²', '') + 'æ°´';
            elements.playerColorText.textContent = colorName;
            elements.playerColorText.style.color = colorValue;
            elements.pouringLiquid.style.backgroundColor = colorValue;
        }

        // åŠ¨æ€é¢œè‰²åˆ·æ–°ç³»ç»Ÿ
        function refreshPlayerColor() {
            // éšæœºé€‰æ‹©ä¸€ä¸ªæ–°çš„é¢œè‰²ï¼Œç¡®ä¿ä¸å½“å‰é¢œè‰²ä¸åŒ
            const availableColors = colors.filter(color => color !== playerColor);
            const newColor = availableColors[Math.floor(Math.random() * availableColors.length)];
            
            playerColor = newColor;
            updatePlayerColor();
            showColorChangeNotification();
            console.log('Player color refreshed to:', playerColor);
        }

        // é¢œè‰²å˜åŒ–é€šçŸ¥ç³»ç»Ÿï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        function showColorChangeNotification() {
            // è·å–ç©å®¶ç“¶å­çš„ä½ç½®
            const playerBottleContainer = document.getElementById('player-bottle-container');
            const rect = playerBottleContainer.getBoundingClientRect();
            
            const notification = document.createElement('div');
            notification.className = 'fixed bg-white text-gray-800 px-3 py-2 rounded-lg font-medium text-sm shadow-lg border-2 z-50 transition-all duration-300';
            notification.style.borderColor = colorMap[playerColor];
            notification.style.left = (rect.left + rect.width / 2) + 'px';
            notification.style.top = (rect.top - 50) + 'px';
            notification.style.transform = 'translateX(-50%)';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full border border-gray-300" style="background-color: ${colorMap[playerColor]}"></div>
                    <span>${colorNames[playerColor]}</span>
                </div>
            `;
            
            // æ·»åŠ å†’æ³¡åŠ¨ç”»
            notification.style.animation = 'bubble-up 0.8s ease-out forwards';
            
            // 0.8ç§’åè‡ªåŠ¨æ¶ˆå¤±
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(-50%) translateY(-10px)';
                setTimeout(() => notification.remove(), 200);
            }, 600);
        }

        // æ›´æ–°ç§¯åˆ†æ˜¾ç¤º
        function updatePointsDisplay() {
            elements.pointsDisplay.textContent = `ç§¯åˆ†ï¼š${points}`;
        }

        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartButtonState() {
            if (points >= 10) {
                elements.startBtn.disabled = false;
                elements.startBtn.className = 'px-8 py-3 rounded-xl font-bold transition-all bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white shadow-lg';
                elements.startBtn.textContent = 'å¼€å§‹æŒ‘æˆ˜ (-10ç§¯åˆ†)';
            } else {
                elements.startBtn.disabled = true;
                elements.startBtn.className = 'px-8 py-3 rounded-xl font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
                elements.startBtn.textContent = 'ç§¯åˆ†ä¸è¶³';
            }
        }

        // æ›´æ–°é‡è¯•æŒ‰é’®çŠ¶æ€
        function updateRetryButtonState() {
            if (points >= 10) {
                elements.retryBtn.disabled = false;
                elements.retryBtn.className = 'px-8 py-3 bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 text-white rounded-xl font-bold transition-all shadow-lg';
                elements.retryBtn.textContent = 'å†è¯•ä¸€æ¬¡ (-10ç§¯åˆ†)';
            } else {
                elements.retryBtn.disabled = true;
                elements.retryBtn.className = 'px-8 py-3 bg-gray-300 text-gray-500 rounded-xl font-bold cursor-not-allowed';
                elements.retryBtn.textContent = 'ç§¯åˆ†ä¸è¶³';
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            if (points < 10) {
                showToast('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å¼€å§‹æŒ‘æˆ˜ï¼');
                return;
            }

            console.log('Starting game...');
            points -= 10;
            updatePointsDisplay();

            // æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }

            // éšæœºåŒ–ç©å®¶ç“¶é¢œè‰²
            randomizePlayerColor();

            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = 'playing';
            currentLayer = 1;
            completedLayerColors = [];
            colorIndex = 0;
            currentLayerColor = colors[colorIndex];
            isAnimating = false;  // é‡ç½®åŠ¨ç”»çŠ¶æ€

            // éšè—ç­‰å¾…è¦†ç›–å±‚
            elements.waitingOverlay.classList.add('hidden');

            // æ˜¾ç¤ºæ¸¸æˆUI
            elements.gameHint.classList.remove('hidden');
            elements.clickHint.classList.remove('hidden');
            elements.colorIndicator.classList.remove('hidden');

            // éšæœºç”Ÿæˆä¸¤å±‚ç›®æ ‡é¢œè‰²
            layerColors = [
                colors[Math.floor(Math.random() * colors.length)],
                colors[Math.floor(Math.random() * colors.length)]
            ];

            // é‡ç½®å±‚æ˜¾ç¤º
            elements.layer1.classList.remove('hidden');
            elements.layer2.classList.add('hidden');
            elements.layerProgress.textContent = '1/2';

            // ç¡®ä¿å±‚çº§å®šä½æ­£ç¡®
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';

            // è®¾ç½®åˆå§‹é¢œè‰²åå†æ›´æ–°å±‚çº§æ˜¾ç¤º
            elements.layer1.style.backgroundColor = colorMap[currentLayerColor];
            
            // æ›´æ–°å±‚çº§æ˜¾ç¤º
            updateLayerDisplay();

            // æ›´æ–°æç¤º
            updateGameHint();

            // å¼€å§‹é¢œè‰²å¾ªç¯
            startColorCycle();

            console.log('Game started successfully');
        }

        // æ›´æ–°æ¸¸æˆæç¤º
        function updateGameHint() {
            elements.currentLayerHint.textContent = currentLayer;
            elements.hintColor.textContent = colorNames[playerColor];
            elements.hintColor.style.color = colorMap[playerColor];
        }

        // æ™ºèƒ½æ—¶é—´æ§åˆ¶ç³»ç»Ÿ
        function getCurrentColorDuration() {
            if (currentLayerColor === playerColor) {
                return 1000; // åŒ¹é…é¢œè‰²æ˜¾ç¤º1ç§’
            } else {
                return 500;  // éåŒ¹é…é¢œè‰²æ˜¾ç¤º0.5ç§’
            }
        }

        // å¼€å§‹é¢œè‰²å¾ªç¯
        function startColorCycle() {
            if (colorTimer) {
                clearTimeout(colorTimer);
            }

            // åˆå§‹åŒ–è¿›åº¦æ¡
            elements.countdownBar.style.width = '100%';

            function cycleColor() {
                if (gameState !== 'playing') return;

                // åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé¢œè‰²
                colorIndex = (colorIndex + 1) % colors.length;
                currentLayerColor = colors[colorIndex];

                // æ›´æ–°å½“å‰å±‚çš„é¢œè‰²
                const currentLayerElement = currentLayer === 1 ? elements.layer1 : elements.layer2;
                currentLayerElement.style.backgroundColor = colorMap[currentLayerColor];

                // æ›´æ–°é¢œè‰²æŒ‡ç¤ºå™¨
                updateColorIndicator();

                // é‡ç½®è¿›åº¦æ¡åŠ¨ç”»
                const duration = getCurrentColorDuration();
                startCountdownAnimation(duration);

                console.log('Color changed to:', currentLayerColor, 'Duration:', duration + 'ms');

                // ä½¿ç”¨æ™ºèƒ½æ—¶é—´æ§åˆ¶è®¾ç½®ä¸‹æ¬¡åˆ‡æ¢
                colorTimer = setTimeout(cycleColor, duration);
            }

            // å¼€å§‹ç¬¬ä¸€æ¬¡å€’è®¡æ—¶åŠ¨ç”»
            const initialDuration = getCurrentColorDuration();
            startCountdownAnimation(initialDuration);
            colorTimer = setTimeout(cycleColor, initialDuration);
        }

        // å¼€å§‹å€’è®¡æ—¶åŠ¨ç”»ï¼ˆæ”¯æŒåŠ¨æ€æ—¶é•¿ï¼‰
        function startCountdownAnimation(duration = 2000) {
            // é‡ç½®è¿›åº¦æ¡åˆ°100%
            elements.countdownBar.style.width = '100%';

            // ä½¿ç”¨requestAnimationFrameåˆ›å»ºå¹³æ»‘åŠ¨ç”»
            let startTime = null;

            function animate(currentTime) {
                if (startTime === null) startTime = currentTime;
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // è®¡ç®—å½“å‰å®½åº¦ï¼ˆä»100%åˆ°0%ï¼‰
                const width = (1 - progress) * 100;
                elements.countdownBar.style.width = width + '%';

                // å¦‚æœåŠ¨ç”»æœªå®Œæˆä¸”æ¸¸æˆä»åœ¨è¿›è¡Œï¼Œç»§ç»­åŠ¨ç”»
                if (progress < 1 && gameState === 'playing') {
                    requestAnimationFrame(animate);
                }
            }

            requestAnimationFrame(animate);
        }

        // å±‚çº§çŠ¶æ€ç®¡ç†
        function updateLayerDisplay() {
            console.log('Updating layer display - currentLayer:', currentLayer, 'completedLayerColors:', completedLayerColors);
            
            // ç¡®ä¿å±‚çº§å®šä½å§‹ç»ˆæ­£ç¡®
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';
            
            // ç¬¬ä¸€å±‚çŠ¶æ€
            if (currentLayer > 1) {
                // å·²å®Œæˆå±‚ï¼šç»¿è‰²è¾¹æ¡† + å›ºå®šé¢œè‰² + ç§»é™¤åŠ¨ç”»
                elements.layer1.style.borderColor = '#10b981';
                elements.layer1.style.borderWidth = '3px';
                elements.layer1.style.backgroundColor = colorMap[completedLayerColors[0]];
                elements.layer1.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                elements.layer1.style.animation = 'none';
                elements.layer1.style.opacity = '1';
                // å†æ¬¡ç¡®ä¿å®šä½æ­£ç¡®
                elements.layer1.style.bottom = '0px';
                elements.layer1.style.height = '40px';
            } else {
                // å½“å‰æŒ‘æˆ˜å±‚ï¼šé‡‘è‰²è¾¹æ¡† + å˜åŒ–é¢œè‰² + åŠ¨ç”»æ•ˆæœ
                elements.layer1.style.borderColor = '#f59e0b';
                elements.layer1.style.borderWidth = '3px';
                elements.layer1.style.backgroundColor = colorMap[currentLayerColor];
                elements.layer1.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.5)';
                elements.layer1.style.animation = 'layer-pulse 1s ease-in-out infinite alternate';
                elements.layer1.style.opacity = '1';
                // å†æ¬¡ç¡®ä¿å®šä½æ­£ç¡®
                elements.layer1.style.bottom = '0px';
                elements.layer1.style.height = '40px';
            }

            // ç¬¬äºŒå±‚çŠ¶æ€
            if (currentLayer > 2) {
                // å·²å®Œæˆå±‚ï¼šç»¿è‰²è¾¹æ¡† + å›ºå®šé¢œè‰²
                elements.layer2.style.borderColor = '#10b981';
                elements.layer2.style.borderWidth = '3px';
                elements.layer2.style.backgroundColor = colorMap[completedLayerColors[1]];
                elements.layer2.style.boxShadow = '0 0 10px rgba(16, 185, 129, 0.5)';
                elements.layer2.style.animation = 'none';
                elements.layer2.style.opacity = '1';
                // å†æ¬¡ç¡®ä¿å®šä½æ­£ç¡®
                elements.layer2.style.bottom = '40px';
                elements.layer2.style.height = '40px';
            } else if (currentLayer === 2) {
                // å½“å‰æŒ‘æˆ˜å±‚ï¼šé‡‘è‰²è¾¹æ¡† + å˜åŒ–é¢œè‰² + åŠ¨ç”»æ•ˆæœ
                elements.layer2.style.borderColor = '#f59e0b';
                elements.layer2.style.borderWidth = '3px';
                elements.layer2.style.backgroundColor = colorMap[currentLayerColor];
                elements.layer2.style.boxShadow = '0 0 15px rgba(251, 191, 36, 0.5)';
                elements.layer2.style.animation = 'layer-pulse 1s ease-in-out infinite alternate';
                elements.layer2.style.opacity = '1';
                // ç¡®ä¿ç¬¬äºŒå±‚å¯è§
                elements.layer2.classList.remove('hidden');
                // å†æ¬¡ç¡®ä¿å®šä½æ­£ç¡®
                elements.layer2.style.bottom = '40px';
                elements.layer2.style.height = '40px';
            } else {
                // æœªåˆ°è¾¾å±‚ï¼šä¿æŒéšè—
                elements.layer2.classList.add('hidden');
            }
        }

        // æ›´æ–°é¢œè‰²æŒ‡ç¤ºå™¨
        function updateColorIndicator() {
            colors.forEach((color, index) => {
                const indicator = document.getElementById(`color-${color}`);
                if (color === currentLayerColor) {
                    indicator.className = 'w-4 h-4 rounded-full border-2 transition-all duration-200 scale-125 border-white shadow-lg';
                    indicator.style.opacity = '1';
                } else {
                    indicator.className = 'w-4 h-4 rounded-full border-2 transition-all duration-200 scale-100 border-gray-400 opacity-60';
                }
            });
        }

        // é¢œè‰²åŒ¹é…é€»è¾‘
        function checkLayerMatch() {
            // ç®€åŒ–é€»è¾‘ï¼šåªè¦å½“å‰æ˜¾ç¤ºé¢œè‰²ä¸ç©å®¶é¢œè‰²åŒ¹é…å°±æˆåŠŸ
            // è¿™æ ·ç¡®ä¿æ¸¸æˆæ˜¯å¯ä»¥å®Œæˆçš„
            return currentLayerColor === playerColor;
        }

        // å¤„ç†å±å¹•ç‚¹å‡»äº‹ä»¶
        function handleScreenClick(event) {
            if (gameState !== 'playing' || isAnimating) return;

            console.log('Screen clicked! Player color:', playerColor, 'Current layer color:', currentLayerColor, 'Target layer color:', layerColors[currentLayer - 1]);

            // ä½¿ç”¨åŒé‡éªŒè¯æ£€æŸ¥åŒ¹é…
            if (checkLayerMatch()) {
                // æˆåŠŸåŒ¹é…
                handleSuccessfulMatch();
            } else {
                // åŒ¹é…å¤±è´¥
                handleFailedMatch();
            }
        }

        // å¤„ç†æˆåŠŸåŒ¹é…
        function handleSuccessfulMatch() {
            isAnimating = true;

            // åœæ­¢é¢œè‰²å¾ªç¯
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }

            // æ˜¾ç¤ºå€’æ°´åŠ¨ç”»
            showPouringAnimation();

            // è®°å½•å®Œæˆçš„å±‚é¢œè‰²
            completedLayerColors.push(currentLayerColor);

            setTimeout(() => {
                if (currentLayer === 1) {
                    // å®Œæˆç¬¬ä¸€å±‚ï¼Œè¿›å…¥ç¬¬äºŒå±‚
                    currentLayer = 2;
                    elements.layerProgress.textContent = '2/2';

                    // åˆ·æ–°ç©å®¶ç“¶é¢œè‰²ï¼ˆåŠ¨æ€éš¾åº¦ç³»ç»Ÿï¼‰
                    refreshPlayerColor();
                    updateGameHint();

                    // é‡æ–°å¼€å§‹é¢œè‰²å¾ªç¯
                    colorIndex = 0;
                    currentLayerColor = colors[colorIndex];
                    
                    // æ›´æ–°å±‚çº§æ˜¾ç¤ºï¼ˆåœ¨è®¾ç½®é¢œè‰²ä¹‹åï¼‰
                    updateLayerDisplay();
                    
                    // æ›´æ–°é¢œè‰²æŒ‡ç¤ºå™¨
                    updateColorIndicator();

                    isAnimating = false;
                    startColorCycle();

                    console.log('Layer 1 completed, moving to layer 2');
                } else {
                    // å®Œæˆç¬¬äºŒå±‚ï¼Œæ¸¸æˆèƒœåˆ©
                    gameState = 'completed';
                    showVictorySequence();
                    console.log('Game completed successfully!');
                }
            }, 1800); // å¢åŠ åˆ°1800msä»¥é€‚åº”æ–°çš„åŠ¨ç”»æ—¶é•¿
        }

        // å¤„ç†åŒ¹é…å¤±è´¥
        function handleFailedMatch() {
            gameState = 'failed';

            // åœæ­¢é¢œè‰²å¾ªç¯
            if (colorTimer) {
                clearTimeout(colorTimer);
                colorTimer = null;
            }

            // æ›´æ–°å¤±è´¥æ¶ˆæ¯
            elements.targetColorFailed.textContent = colorNames[currentLayerColor];
            elements.targetColorFailed.style.color = colorMap[currentLayerColor];
            elements.playerColorFailed.textContent = colorNames[playerColor];
            elements.playerColorFailed.style.color = colorMap[playerColor];

            // æ˜¾ç¤ºå¤±è´¥è¦†ç›–å±‚
            elements.failedOverlay.classList.remove('hidden');

            // éšè—æ¸¸æˆUI
            elements.gameHint.classList.add('hidden');
            elements.clickHint.classList.add('hidden');
            elements.colorIndicator.classList.add('hidden');

            // æ›´æ–°é‡è¯•æŒ‰é’®çŠ¶æ€
            updateRetryButtonState();

            console.log('Game failed - color mismatch');
        }

        // æ˜¾ç¤ºå€’æ°´åŠ¨ç”»
        function showPouringAnimation() {
            const playerBottleContainer = document.getElementById('player-bottle-container');
            
            // ç¬¬ä¸€é˜¶æ®µï¼šç§»åŠ¨åˆ°ç›®æ ‡ä½ç½® (600ms)
            playerBottleContainer.style.animation = 'bottle-move-to-target 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards';
            
            setTimeout(() => {
                // ç¬¬äºŒé˜¶æ®µï¼šå¼€å§‹å€’æ°´åŠ¨ç”» (400ms)
                playerBottleContainer.style.animation = 'bottle-pour 0.4s ease-in-out forwards';
                
                // æ˜¾ç¤ºå€’æ°´æ¶²ä½“æ•ˆæœ
                elements.pouringAnimation.classList.remove('hidden');
                elements.pouringText.classList.remove('hidden');
                
                // åŠ¨æ€è®¡ç®—å€’æ°´ä½ç½®
                const targetBottleRect = elements.targetBottle.getBoundingClientRect();
                const gameAreaRect = elements.gameArea.getBoundingClientRect();
                
                const relativeLeft = ((targetBottleRect.left - gameAreaRect.left) / gameAreaRect.width) * 100;
                const relativeTop = ((targetBottleRect.top - gameAreaRect.top) / gameAreaRect.height) * 100;
                
                elements.pouringAnimation.style.left = relativeLeft + '%';
                elements.pouringAnimation.style.top = (relativeTop - 5) + '%';
                elements.pouringAnimation.style.transform = 'translateX(-50%)';
                
                // æ·»åŠ æ¶²ä½“æµåŠ¨åŠ¨ç”»
                elements.pouringLiquid.style.animation = 'liquid-pour 0.8s ease-out forwards';
                
                // åœ¨æ¶²ä½“å¼€å§‹æµåŠ¨å200msæ˜¾ç¤ºæˆåŠŸæç¤ºï¼ˆæ›´ç¬¦åˆè§†è§‰é€»è¾‘ï¼‰
                setTimeout(() => {
                    showSuccessText();
                }, 200);
                
                setTimeout(() => {
                    // ç¬¬ä¸‰é˜¶æ®µï¼šå›åˆ°åˆå§‹ä½ç½® (500ms)
                    playerBottleContainer.style.animation = 'bottle-return 0.5s cubic-bezier(0.55, 0.06, 0.68, 0.19) forwards';
                    
                    // éšè—å€’æ°´æ•ˆæœ
                    elements.pouringAnimation.classList.add('hidden');
                    elements.pouringText.classList.add('hidden');
                    
                    setTimeout(() => {
                        // æ¸…é™¤åŠ¨ç”»æ ·å¼ï¼Œç¡®ä¿ç“¶å­å›åˆ°åˆå§‹çŠ¶æ€
                        playerBottleContainer.style.animation = '';
                        elements.pouringLiquid.style.animation = '';
                    }, 500);
                }, 400);
            }, 600);
        }

        // æ˜¾ç¤ºæˆåŠŸæ–‡æœ¬åé¦ˆ
        function showSuccessText() {
            const currentLayerElement = currentLayer === 1 ? elements.layer1 : elements.layer2;
            const successText = document.createElement('div');
            successText.className = 'success-text';
            successText.textContent = 'æˆåŠŸï¼';
            // ä¸è¦æ”¹å˜å±‚çº§å…ƒç´ çš„positionï¼Œä¿æŒabsoluteå®šä½
            // currentLayerElement.style.position = 'relative'; // åˆ é™¤è¿™è¡Œ
            currentLayerElement.appendChild(successText);
            
            setTimeout(() => {
                if (successText.parentNode) {
                    successText.parentNode.removeChild(successText);
                }
            }, 2000);
        }

        // æ˜¾ç¤ºèƒœåˆ©åºåˆ—
        function showVictorySequence() {
            // éšè—æ¸¸æˆUI
            elements.gameHint.classList.add('hidden');
            elements.clickHint.classList.add('hidden');
            elements.colorIndicator.classList.add('hidden');

            // ç”Ÿæˆå¥–åŠ±
            reward = generateReward();

            // æ˜¾ç¤ºç¤¼ç›’åŠ¨ç”»
            showGiftBoxAnimation();
        }

        // ç”Ÿæˆå¥–åŠ±
        function generateReward() {
            const rand = Math.random();
            if (rand < 0.35) return rewards[0]; // 35% - 1 ç§¯åˆ†
            if (rand < 0.60) return rewards[1]; // 25% - 10 ç§¯åˆ†
            if (rand < 0.75) return rewards[2]; // 15% - 18 ç§¯åˆ†
            if (rand < 0.85) return rewards[3]; // 10% - 38 ç§¯åˆ†
            if (rand < 0.93) return rewards[4]; // 8% - 88 ç§¯åˆ†
            if (rand < 0.98) return rewards[5]; // 5% - 188 ç§¯åˆ†
            return rewards[6]; // 2% - 388 ç§¯åˆ†
        }

        // æ˜¾ç¤ºç¤¼ç›’åŠ¨ç”»
        function showGiftBoxAnimation() {
            elements.giftBoxContainer.classList.remove('hidden');
            elements.giftBoxContainer.style.pointerEvents = 'auto';

            // 3ç§’åè‡ªåŠ¨å¼€å¯
            let countdownSeconds = 3;
            const countdownText = document.getElementById('countdown-text');

            countdownTimer = setInterval(() => {
                countdownSeconds--;
                countdownText.textContent = countdownSeconds;

                if (countdownSeconds <= 0) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    openGiftBox();
                }
            }, 1000);

            // ç‚¹å‡»å¼€å¯
            const giftBoxClosed = document.getElementById('gift-box-closed');
            giftBoxClosed.addEventListener('click', (e) => {
                e.stopPropagation();
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    openGiftBox();
                }
            });
        }

        // å¼€å¯ç¤¼ç›’
        function openGiftBox() {
            if (reward) {
                const rewardText = `+${reward.amount} ç§¯åˆ†!`;
                // æ›´æ–°å¥–åŠ±æ–‡æœ¬æ˜¾ç¤º
                const rewardTextElement = document.getElementById('flying-reward').querySelector('div div:last-child');
                rewardTextElement.textContent = rewardText;

                // åˆ‡æ¢åˆ°å¼€å¯çŠ¶æ€
                document.getElementById('gift-box-closed').classList.add('hidden');
                document.getElementById('gift-box-opened').classList.remove('hidden');
                document.getElementById('flying-reward').classList.remove('hidden');

                // æ˜¾ç¤ºå½©å¸¦æ•ˆæœ
                showConfettiEffect();

                // 2ç§’åæ˜¾ç¤ºå¥–åŠ±ç•Œé¢
                setTimeout(() => {
                    hideGiftBoxAnimation();
                    showRewardOverlay();
                }, 2000);
            }
        }

        // éšè—ç¤¼ç›’åŠ¨ç”»
        function hideGiftBoxAnimation() {
            elements.giftBoxContainer.classList.add('hidden');
            elements.giftBoxContainer.style.pointerEvents = 'none';
        }

        // æ˜¾ç¤ºå¥–åŠ±è¦†ç›–å±‚
        function showRewardOverlay() {
            if (reward) {
                // æ›´æ–°å¥–åŠ±æ˜¾ç¤º
                elements.rewardDisplay.innerHTML = `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-full font-bold text-xl shadow-lg border-2 border-yellow-300">
                        +${reward.amount} ç§¯åˆ†!
                    </div>
                `;

                // å¢åŠ ç§¯åˆ†
                points += reward.amount;
                updatePointsDisplay();

                // æ˜¾ç¤ºå¥–åŠ±è¦†ç›–å±‚
                elements.rewardOverlay.classList.remove('hidden');
            }
        }

        // æ˜¾ç¤ºå½©å¸¦æ•ˆæœ
        function showConfettiEffect() {
            elements.confettiContainer.classList.remove('hidden');

            // è·å–ç›®æ ‡ç“¶å­çš„ä½ç½®
            const targetBottle = elements.targetBottle;
            const bottleRect = targetBottle.getBoundingClientRect();
            const containerRect = elements.confettiContainer.getBoundingClientRect();

            // è®¡ç®—ç›®æ ‡ç“¶å­åœ¨å®¹å™¨ä¸­çš„ç›¸å¯¹ä½ç½®
            const centerX = (bottleRect.left + bottleRect.width / 2 - containerRect.left) / containerRect.width * 100;
            const centerY = (bottleRect.top + bottleRect.height / 2 - containerRect.top) / containerRect.height * 100;

            // åˆ›å»ºå½©å¸¦ç‰‡æ®µ
            for (let i = 0; i < 40; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti-piece';

                // éšæœºé¢œè‰²
                const colorIndex = Math.floor(Math.random() * colors.length);
                const colorValue = colorMap[colors[colorIndex]];
                confetti.style.backgroundColor = colorValue;

                // ä»ç“¶å­ä¸­å¿ƒä½ç½®å¼€å§‹
                confetti.style.left = centerX + '%';
                confetti.style.top = centerY + '%';

                // éšæœºçˆ†ç‚¸æ–¹å‘å’Œè·ç¦»
                const angle = (Math.PI * 2 * i) / 40 + (Math.random() - 0.5) * 0.5;
                const distance = 50 + Math.random() * 100;
                const endX = centerX + Math.cos(angle) * distance / containerRect.width * 100;
                const endY = centerY + Math.sin(angle) * distance / containerRect.height * 100 + Math.random() * 50;

                // è®¾ç½®CSSå˜é‡ç”¨äºåŠ¨ç”»
                confetti.style.setProperty('--end-x', endX + '%');
                confetti.style.setProperty('--end-y', endY + '%');
                confetti.style.setProperty('--rotation', Math.random() * 720 + 'deg');
                confetti.style.animationDelay = Math.random() * 0.3 + 's';
                confetti.style.animation = 'confettiBurst 2s ease-out forwards';

                elements.confettiContainer.appendChild(confetti);
            }

            // 2ç§’åæ¸…ç†å½©å¸¦
            setTimeout(() => {
                elements.confettiContainer.innerHTML = '';
                elements.confettiContainer.classList.add('hidden');
            }, 2000);
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            if (points < 10) {
                showToast('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•é‡æ–°å¼€å§‹ï¼');
                return;
            }

            // éšè—å¤±è´¥è¦†ç›–å±‚
            elements.failedOverlay.classList.add('hidden');

            // é‡æ–°å¼€å§‹æ¸¸æˆ
            startGame();
        }

        // å¼€å§‹æ–°æŒ‘æˆ˜
        function startNewChallenge() {
            if (points < 10) {
                showToast('ç§¯åˆ†ä¸è¶³ï¼Œæ— æ³•å¼€å§‹æŒ‘æˆ˜ï¼');
                return;
            }

            // éšè—å¥–åŠ±ç•Œé¢
            elements.rewardOverlay.classList.add('hidden');

            // é‡æ–°å¼€å§‹æ¸¸æˆ
            startGame();
        }

        // åˆ†äº«ç»“æœ
        function shareResult() {
            if (reward) {
                const shareText = `ğŸ‰ æˆ‘åœ¨å¹¸è¿ä¸€æ»´æ¸¸æˆä¸­è·å¾—äº†${reward.name}ï¼å½“å‰ç§¯åˆ†ï¼š${points} åˆ†ï¼å¿«æ¥æŒ‘æˆ˜å§ï¼`;

                if (navigator.share) {
                    navigator.share({
                        title: 'å¹¸è¿ä¸€æ»´æ¸¸æˆ',
                        text: shareText,
                        url: window.location.href
                    });
                } else {
                    // å¤åˆ¶åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(shareText).then(() => {
                        showToast('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                    });
                }
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-6 py-3 rounded-full z-50 transition-opacity';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 2000);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            console.log('Initializing game...');

            // ç¡®ä¿å±‚çº§å®šä½æ­£ç¡®
            elements.layer1.style.position = 'absolute';
            elements.layer1.style.bottom = '0px';
            elements.layer1.style.height = '40px';
            elements.layer2.style.position = 'absolute';
            elements.layer2.style.bottom = '40px';
            elements.layer2.style.height = '40px';

            // éšæœºåŒ–åˆå§‹ç©å®¶ç“¶é¢œè‰²
            randomizePlayerColor();

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateStartButtonState();
            updatePointsDisplay();

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            elements.startBtn.addEventListener('click', startGame);
            elements.retryBtn.addEventListener('click', resetGame);
            elements.continueBtn.addEventListener('click', startNewChallenge);
            elements.shareBtn.addEventListener('click', shareResult);

            // ä¸ºç›®æ ‡ç“¶å’Œæ¸¸æˆåŒºåŸŸæ·»åŠ ç‚¹å‡»äº‹ä»¶
            elements.targetBottle.addEventListener('click', handleScreenClick);
            elements.gameArea.addEventListener('click', handleScreenClick);

            console.log('Game initialized successfully');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);

        console.log('JavaScript loaded successfully');
    </script>
</body>

</html>